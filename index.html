<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>八卦象数疗法检索</title>
    <style>
        :root {
            --primary-color: #07c160; 
            --accent-color: #d32f2f;  
            --bg-color: #f4f6f9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { background-color: var(--bg-color); color: #333; line-height: 1.5; }
        .container { max-width: 600px; margin: 0 auto; padding: 12px; }

        /* 顶部搜索：固定在上方 */
        .header { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .header h1 { font-size: 20px; text-align: center; margin-bottom: 15px; color: #000; }
        
        .search-box { display: flex; gap: 8px; }
        #search-input { 
            flex: 1; padding: 12px; border: 1px solid #ddd; 
            border-radius: 8px; background: #f9f9f9; font-size: 16px; outline: none;
        }
        #search-btn { padding: 0 18px; background: var(--primary-color); color: #fff; border: none; border-radius: 8px; font-weight: bold; }

        /* 分类网格：3列5行（共15个） */
        .category-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); 
            gap: 8px; margin-bottom: 20px; list-style: none;
        }
        .cat-item { 
            background: #fff; padding: 12px 5px; border-radius: 8px; border: 1px solid #eee;
            font-size: 13px; text-align: center; color: #666; cursor: pointer;
            display: flex; align-items: center; justify-content: center; height: 50px;
        }
        .cat-item.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); font-weight: bold; }

        /* 卡片设计：字号统一，拒绝忽大忽小 */
        .card-container { display: flex; flex-direction: column; gap: 12px; }
        .card { background: #fff; border-radius: 15px; padding: 18px; border: 1px solid #eaeaea; }
        
        .card-title { 
            font-size: 18px; font-weight: bold; color: #000; margin-bottom: 12px;
            display: flex; align-items: flex-start; gap: 6px;
        }
        .card-title::before { content: ""; width: 4px; height: 18px; background: var(--primary-color); border-radius: 2px; margin-top: 4px; flex-shrink: 0; }
        
        .formula-box { 
            background: #fff5f5; border-radius: 10px; padding: 15px; 
            text-align: center; margin-bottom: 12px; border: 1px dashed #ffcdd2;
        }
        .formula { color: var(--accent-color); font-size: 26px; font-weight: 800; letter-spacing: 1.5px; }
        
        .desc-box { font-size: 14px; color: #666; border-top: 1px solid #f2f2f2; padding-top: 10px; }
        .desc-label { color: var(--primary-color); font-weight: bold; font-size: 12px; margin-bottom: 4px; display: block; }
        
        #status { text-align: center; font-size: 12px; color: #999; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>象数疗法检索</h1>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="输入病名搜索...">
                <button id="search-btn">搜索</button>
            </div>
        </div>

        <div id="status">正在同步精准数据...</div>

        <ul class="category-grid" id="category-list"></ul>

        <main class="card-container" id="card-container"></main>
    </div>

    <script>
        let fullData = [];

        async function start() {
            try {
                const res = await fetch('data.json');
                const raw = await res.json();
                
                // 【核心：防错拦截逻辑】
                fullData = raw.filter(item => {
                    // 1. 过滤掉公式太短的（比如纯页码64, 65）
                    const validFormula = item.formula && item.formula.length >= 3;
                    // 2. 过滤掉标题是纯数字的（页码误抓）
                    const validTitle = item.title && !/^\d+$/.lastIndex && item.title.length > 1;
                    // 3. 过滤掉无效字符标题
                    const notTrash = !["或", "或或", "或方", "说明"].includes(item.title);
                    
                    return validFormula && validTitle && notTrash;
                });

                renderSidebar();
                renderCards(fullData);
                document.getElementById('status').innerText = `已为您整理出 ${fullData.length} 条有效配方`;
            } catch (e) {
                document.getElementById('status').innerText = "数据加载失败，请检查 JSON 路径";
            }
        }

        function renderSidebar() {
            const list = document.getElementById('category-list');
            const exclude = ["通用", "说明", "页码"];
            let cats = [...new Set(fullData.map(i => i.category))];
            
            // 选出前 14 个分类，加上“全部内容”共 15 个
            cats = cats.filter(c => c && !exclude.some(ex => c.includes(ex))).slice(0, 14);
            const finalCats = ["全部内容", ...cats];

            list.innerHTML = finalCats.map(cat => `
                <li class="cat-item ${cat==='全部内容'?'active':''}" onclick="filterCat('${cat}', this)">
                    ${cat.replace('配方', '')}
                </li>
            `).join('');
        }

        function renderCards(data) {
            const container = document.getElementById('card-container');
            if (data.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#999;padding:40px;">未找到匹配结果</div>';
                return;
            }
            container.innerHTML = data.map(item => `
                <div class="card">
                    <div class="card-title">${item.title}</div>
                    <div class="formula-box">
                        <div class="formula">${item.formula}</div>
                    </div>
                    <div class="desc-box">
                        <span class="desc-label">说明建议：</span>
                        ${item.content || '详见书中描述。'}
                    </div>
                </div>
            `).join('');
        }

        function filterCat(cat, el) {
            document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            const filtered = (cat === "全部内容") ? fullData : fullData.filter(i => i.category === cat);
            renderCards(filtered);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function doSearch() {
            const kw = document.getElementById('search-input').value.trim().toLowerCase();
            const res = fullData.filter(i => 
                i.title.toLowerCase().includes(kw) || 
                i.formula.includes(kw) ||
                (i.content && i.content.toLowerCase().includes(kw))
            );
            renderCards(res);
            document.getElementById('status').innerText = `找到 ${res.length} 条相关结果`;
        }

        document.getElementById('search-btn').onclick = doSearch;
        document.getElementById('search-input').onkeyup = (e) => { if(e.key === 'Enter') doSearch(); };

        start();
    </script>
</body>
</html>
